# ğŸ” Authentication & API Flow Diagram

## Token Minting Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser (Client)                             â”‚
â”‚                                                                  â”‚
â”‚  1. Page Loads                                                   â”‚
â”‚     â†“                                                             â”‚
â”‚  2. JavaScript runs:                                             â”‚
â”‚     window.addEventListener('load', function() {                â”‚
â”‚       fetch('/mint-token/', {method: 'GET'})                     â”‚
â”‚     })                                                            â”‚
â”‚     â†“                                                             â”‚
â”‚  3. Server Returns:                                              â”‚
â”‚     {                                                             â”‚
â”‚       "ok": true,                                                â”‚
â”‚       "token": "eyJ0eXAi...",  â† JWT Token                      â”‚
â”‚       "user_id": "...",                                          â”‚
â”‚       "username": "robert",                                      â”‚
â”‚       "user_role": "Admin"                                       â”‚
â”‚     }                                                             â”‚
â”‚     â†“                                                             â”‚
â”‚  4. Store in localStorage:                                       â”‚
â”‚     localStorage.setItem('jwt_token', 'eyJ0eXAi...')            â”‚
â”‚     â†“                                                             â”‚
â”‚  5. Console shows:                                               â”‚
â”‚     âœ… Token minted for robert (role: Admin)                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘ â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Django Server                                  â”‚
â”‚                                                                  â”‚
â”‚  @login_required                                                 â”‚
â”‚  def mint_token(request):                                        â”‚
â”‚      token = AccessToken.for_user(request.user)                 â”‚
â”‚      return JsonResponse({                                       â”‚
â”‚          "token": str(token),  â† Returns JWT                    â”‚
â”‚          ...                                                      â”‚
â”‚      })                                                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Request Flow (With JWT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser (Client)                             â”‚
â”‚                                                                  â”‚
â”‚  User clicks "+ New Chat"                                        â”‚
â”‚     â†“                                                             â”‚
â”‚  JavaScript:                                                     â”‚
â”‚  fetch('/api/chat/session/', {                                  â”‚
â”‚    method: 'POST',                                               â”‚
â”‚    headers: getHeaders(true),  â† Includes JWT!                 â”‚
â”‚    body: JSON.stringify({...})                                  â”‚
â”‚  })                                                              â”‚
â”‚     â†“                                                             â”‚
â”‚  getHeaders() function:                                          â”‚
â”‚  {                                                                â”‚
â”‚    'Content-Type': 'application/json',                           â”‚
â”‚    'X-CSRFToken': '...',                                         â”‚
â”‚    'Authorization': 'Bearer eyJ0eXAi...'  â† JWT Token           â”‚
â”‚  }                                                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Django Server                                  â”‚
â”‚                                                                  â”‚
â”‚  Request arrives with Authorization header:                      â”‚
â”‚    Authorization: Bearer eyJ0eXAi...                             â”‚
â”‚                                                                  â”‚
â”‚  @api_view(['POST'])                                             â”‚
â”‚  @authentication_classes([JWTAuthentication])  â† Validates JWT  â”‚
â”‚  @permission_classes([IsAuthenticated])        â† Checks auth   â”‚
â”‚  def chat_session_create(request):                               â”‚
â”‚      user = request.user  â† User extracted from JWT            â”‚
â”‚      session = ChatSession.objects.create(                       â”‚
â”‚          user=user,  â† Linked to authenticated user             â”‚
â”‚          title=request.data['title']                             â”‚
â”‚      )                                                            â”‚
â”‚      return JsonResponse({...})                                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser (Client)                             â”‚
â”‚                                                                  â”‚
â”‚  Response received with chat session                             â”‚
â”‚  {                                                                â”‚
â”‚    "id": 123,                                                    â”‚
â”‚    "title": "New Chat",                                          â”‚
â”‚    "created_at": "2025-11-11T..."                                â”‚
â”‚  }                                                                â”‚
â”‚     â†“                                                             â”‚
â”‚  Session appears in sidebar                                      â”‚
â”‚  Ready to send messages!                                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Complete Chat Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       STEP 1: PAGE LOAD                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Browser                              Django                      â”‚
â”‚    â”‚                                   â”‚                         â”‚
â”‚    â”œâ”€ GET /                           â”‚                         â”‚
â”‚    â”‚                                   â”‚                         â”‚
â”‚    â”‚ â†â”€â”€â”€â”€â”€â”€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
â”‚    â”‚ (dashboard.html)                 â”‚                         â”‚
â”‚    â”‚                                   â”‚                         â”‚
â”‚    â”œâ”€ GET /mint-token/               â”‚                         â”‚
â”‚    â”‚                                   â”œâ”€ Create JWT             â”‚
â”‚    â”‚ â†â”€ {token: "...", ...} â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
â”‚    â”‚                                   â”‚                         â”‚
â”‚    â””â”€ Store JWT in localStorage       â”‚                         â”‚
â”‚                                        â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STEP 2: CREATE CHAT SESSION                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Browser                              Django                      â”‚
â”‚    â”‚                                   â”‚                         â”‚
â”‚    â”œâ”€ POST /api/chat/session/        â”‚                         â”‚
â”‚    â”‚   Headers: {                     â”‚                         â”‚
â”‚    â”‚     Authorization: Bearer ...    â”‚                         â”‚
â”‚    â”‚   }                              â”‚                         â”‚
â”‚    â”‚   Body: {title: "..."}           â”‚                         â”‚
â”‚    â”‚                                   â”œâ”€ JWTAuth validates      â”‚
â”‚    â”‚                                   â”œâ”€ Create ChatSession      â”‚
â”‚    â”‚ â†â”€ 201 {id: 123, ...} â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
â”‚    â”‚                                   â”‚                         â”‚
â”‚    â””â”€ Display in sidebar              â”‚                         â”‚
â”‚                                        â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STEP 3: SEND MESSAGE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Browser                              Django      OpenAI         â”‚
â”‚    â”‚                                   â”‚           â”‚            â”‚
â”‚    â”œâ”€ POST /api/chat/message/        â”‚           â”‚            â”‚
â”‚    â”‚   Headers: {Authorization: ...}  â”‚           â”‚            â”‚
â”‚    â”‚   Body: {                         â”‚           â”‚            â”‚
â”‚    â”‚     session_id: 123,              â”‚           â”‚            â”‚
â”‚    â”‚     message: "Hello"              â”‚           â”‚            â”‚
â”‚    â”‚   }                               â”‚           â”‚            â”‚
â”‚    â”‚                                   â”œâ”€ Store user message     â”‚
â”‚    â”‚                                   â”œâ”€ Call LLM API â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
â”‚    â”‚                                   â”‚           â”‚            â”‚
â”‚    â”‚                                   â”‚ â†â”€ LLM response â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚    â”‚                                   â”œâ”€ Store assistant msg    â”‚
â”‚    â”‚ â†â”€ 200 {content: "..."} â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚            â”‚
â”‚    â”‚                                   â”‚           â”‚            â”‚
â”‚    â””â”€ Display response in chat         â”‚           â”‚            â”‚
â”‚                                        â”‚           â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STEP 4: LOAD HISTORY                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Browser                              Django                      â”‚
â”‚    â”‚                                   â”‚                         â”‚
â”‚    â”œâ”€ GET /api/chat/history/         â”‚                         â”‚
â”‚    â”‚   ?session_id=123                â”‚                         â”‚
â”‚    â”‚   Headers: {Authorization: ...}  â”‚                         â”‚
â”‚    â”‚                                   â”œâ”€ Query ChatMessage      â”‚
â”‚    â”‚ â†â”€ 200 {messages: [...]} â”€â”€â”€â”€â”€â”¤                         â”‚
â”‚    â”‚                                   â”‚                         â”‚
â”‚    â””â”€ Display all messages            â”‚                         â”‚
â”‚                                        â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## JWT Authentication Flow (Detailed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Browser makes request with JWT in Authorization header:     â”‚
â”‚                                                                  â”‚
â”‚     Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc...             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Django receives request                                     â”‚
â”‚                                                                  â”‚
â”‚     @authentication_classes([JWTAuthentication])                â”‚
â”‚     @permission_classes([IsAuthenticated])                      â”‚
â”‚     def chat_session_create(request):                            â”‚
â”‚         ...                                                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. JWTAuthentication middleware extracts JWT:                  â”‚
â”‚                                                                  â”‚
â”‚     1. Get from Authorization header                             â”‚
â”‚     2. Remove "Bearer " prefix                                   â”‚
â”‚     3. Decode using JWT_SECRET                                   â”‚
â”‚     4. Extract user_id from payload                              â”‚
â”‚     5. Query User model to get request.user                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. IsAuthenticated checks:                                     â”‚
â”‚                                                                  â”‚
â”‚     if request.user and request.user.is_authenticated:           â”‚
â”‚         # Allow access                                           â”‚
â”‚     else:                                                         â”‚
â”‚         # Reject with 401 Unauthorized                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. View function executes with authenticated user:             â”‚
â”‚                                                                  â”‚
â”‚     def chat_session_create(request):                            â”‚
â”‚         # request.user is authenticated                          â”‚
â”‚         # Can safely use request.user.id, etc.                  â”‚
â”‚         session = ChatSession.objects.create(                    â”‚
â”‚             user=request.user,                                   â”‚
â”‚             title=request.data['title']                          â”‚
â”‚         )                                                         â”‚
â”‚         return JsonResponse({...})                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: Message Storage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Message   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ POST /api/chat/message/
         â”‚ {session_id: 123, message: "Hello"}
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create ChatMessage (role=user)          â”‚
â”‚  {                                        â”‚
â”‚    session_id: 123,                       â”‚
â”‚    role: "user",                          â”‚
â”‚    content: "Hello",                      â”‚
â”‚    created_at: now,                       â”‚
â”‚    user_role_at_time: "Admin"            â”‚
â”‚  }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Save to Database
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Call LLM (OpenAI) with message          â”‚
â”‚  client.chat.completions.create(         â”‚
â”‚    model="gpt-4-turbo",                  â”‚
â”‚    messages=[...]                        â”‚
â”‚  )                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Stream response
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create ChatMessage (role=assistant)     â”‚
â”‚  {                                        â”‚
â”‚    session_id: 123,                       â”‚
â”‚    role: "assistant",                     â”‚
â”‚    content: "Hello! How can I help?",    â”‚
â”‚    created_at: now,                       â”‚
â”‚    model_used: "gpt-4-turbo",            â”‚
â”‚    tokens_used: 45,                       â”‚
â”‚    cost_cents: 3                          â”‚
â”‚  }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Save to Database
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Return 200 OK with response             â”‚
â”‚  {                                        â”‚
â”‚    content: "Hello! How can I help?",    â”‚
â”‚    tokens_used: 45,                       â”‚
â”‚    cost_cents: 3                          â”‚
â”‚  }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Send to Browser
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Display in Chat UI                      â”‚
â”‚  - Both messages visible                 â”‚
â”‚  - User message (blue)                   â”‚
â”‚  - Assistant message (light blue)        â”‚
â”‚  - Token count displayed                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Components

### ğŸ”‘ JWT Token
- Created by: `AccessToken.for_user(request.user)`
- Stored in: Browser `localStorage`
- Sent in: `Authorization: Bearer <token>` header
- Validated by: `JWTAuthentication` middleware
- Contains: `user_id`, `exp` (expiration), others

### ğŸ” Authentication Flow
1. User logs in â†’ Django creates session
2. Page loads â†’ Frontend calls `/mint-token/`
3. Backend creates JWT â†’ Returns to frontend
4. Frontend stores in localStorage
5. All API calls include JWT in header
6. Backend validates JWT â†’ Allows access

### ğŸ’¾ Data Storage
- `ChatSession` - One per conversation
- `ChatMessage` - All messages (user + assistant)
- Linked by `session_id` foreign key
- User can only see own sessions (enforced by Django)

### ğŸ”— Security Layers
- JWT authentication (prevents unauthorized access)
- CSRF tokens (prevents cross-site attacks)
- User isolation (can't see other users' data)
- Audit logging (all actions logged)
- Input validation (sanitizes user input)

---

**Status:** âœ… All systems connected and ready to go!
