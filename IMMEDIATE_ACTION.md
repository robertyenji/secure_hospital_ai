# ðŸš€ IMMEDIATE ACTION REQUIRED

## The Fix
JWT token is now **generated by the handler** using `JWT_SECRET` from `.env`

## What to Do (2 minutes)

### Step 1: Check .env
```bash
# Open .env and verify these lines exist:
JWT_SECRET=<your-secret-key>
JWT_ALG=HS256
MCP_SERVER_URL=http://127.0.0.1:5000/mcp/
```

**If JWT_SECRET is missing**: Add it
```
JWT_SECRET=django-insecure-change-this-in-production
```

### Step 2: Restart Django
```bash
# Stop current server:
Ctrl+C

# Start it again:
python manage.py runserver
```

### Step 3: Test in Browser
Ask: **"Get patient medical records for patient ID NUGWI"**

### Step 4: Check Logs
Watch Django terminal for:
```
âœ… "Executing MCP tool get_medical_records"
```

NOT:
```
âŒ "401 Unauthorized"
```

---

## What Changed

**Before** âŒ:
- Handler tried to extract token from Django request
- No token passed to MCP server
- MCP server: 401 Unauthorized

**After** âœ…:
- Handler generates JWT token from user info + JWT_SECRET
- Token signed with same algorithm as MCP server expects
- Token passed in Authorization header
- MCP server: 200 OK âœ…

---

## Why This Works

MCP server code expects:
```python
def get_identity(request: Request) -> Identity:
    auth = request.headers.get("Authorization", "")
    token = auth.split(" ", 1)[1]  # Extract "Bearer <token>"
    claims = jwt.decode(token, JWT_SECRET, algorithms=[JWT_ALG])
    user_id = claims.get("user_id")
    role = claims.get("role")
```

Handler now provides:
```python
mcp_token = jwt.encode(
    {"user_id": str(self.user.id), "role": self.role, ...},
    jwt_secret,
    algorithm=jwt_alg
)
headers = {"Authorization": f"Bearer {mcp_token}"}
```

âœ… Token has user_id and role  
âœ… Token signed with same JWT_SECRET  
âœ… Token in correct Authorization header format  
âœ… MCP can decode and validate  

---

## Success = ðŸŽ‰

When you see:
- Django logs: `Executing MCP tool get_medical_records`
- Browser: Chat shows actual patient records
- No 401 errors

**You're done!**

---

## If Still Getting 401

1. **Check JWT_SECRET exists**:
   ```bash
   python manage.py shell
   import os
   print(f"JWT_SECRET: {os.getenv('JWT_SECRET')}")
   ```

2. **Check it matches MCP server**:
   - Both must use same JWT_SECRET
   - If MCP is separate service, check its .env too

3. **Restart MCP server** (if separate):
   ```bash
   # Kill and restart MCP server
   # It must reload JWT_SECRET from .env
   ```

---

## Files Modified

- âœ… `frontend/llm_handler.py` (added JWT token generation)
- No database changes
- No configuration changes needed (uses existing .env)

---

**Time to fix**: 2 minutes  
**Risk**: Zero (stateless, no DB impact)  
**Expected result**: Patient data in chat responses âœ…

**Go restart Django!** ðŸš€
